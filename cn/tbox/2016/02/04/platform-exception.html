<!DOCTYPE html>
<html>    
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>用c实现跨平台异常捕获机制</title>
  <meta name="description" content="TBOX封装了一套跨平台的异常捕获实现，来模拟windows的seh异常处理功能，而且是线程安全的。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://tboox.net/cn/tbox/2016/02/04/platform-exception.html">
  <link rel="alternate" type="application/atom+xml" title="TBOOX" href="http://tboox.net/feed.xml" />
  <script src="/scripts/jquery-1.11.2.min.js"></script>
  <script src="/scripts/pithy.js"></script>

  <!-- baidu statistics -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1f2e7c366588e460fe2b6f4da3a5746d";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
</head>


  <body>
    <header class="header">
	<div class="header-container">
		<div class="nav">
			
				<li>
					<a href="/cn/index.html">主页</a>
				</li>			
			
			
				<li>
					<a href="/cn/blog.html">博客</a>
				</li>			
			
			
				<li>
					<a href="/cn/documents.html">文档</a>
				</li>			
			
			
				<li>
					<a href="/cn/downloads.html">下载</a>
				</li>			
			
			
				<li>
					<a href="/cn/donation.html">捐助</a>
				</li>			
			
			
				<li>
					<a href="/cn/about.html">关于</a>
				</li>			
			
		</div>
		<div class="description"> 欢迎来到TBOOX开源工程! </div>		
		<ul class="social-links">
			<li>
				<a href="https://github.com/waruqi" title="Github">
					<img width="19px" height="19px" src="/images/github.png"/>
				</a>
			</li>
			<li>
				<a href="/feed.xml" title="RSS">
					<img width="19px" height="19px" src="/images/rss.png"/>
				</a>
			</li>
			<li>
				<a href="https://twitter.com/" title="Twitter">
					<img width="19px" height="19px" src="/images/twitter.png"/>
				</a>
			</li>
		</ul>		
	</div>
</header>

    <br>
    <div class="page-content">
      <div class="wrapper">
        <div class="post">
  <br>
  <header class="post-header">
    <h1 class="post-title">用c实现跨平台异常捕获机制</h1>
    <p class="post-meta">Feb 4, 2016</p>
  </header>

  <article class="post-content">
    <p>TBOX封装了一套跨平台的异常捕获实现，来模拟windows的seh异常处理功能，而且是线程安全的。</p>

<h3 id="linuxmac">在linux/mac下的实现</h3>

<ul>
  <li>使用signal 捕获异常信号</li>
  <li>使用sigsetjmp保存现场寄存器和信号掩码，出现异常后使用 siglongjmp 跳转到异常处理过程，并恢复状态</li>
  <li>使用线程局部存储维护 sigjmpbuf 寄存器现场状态堆栈，保证多线程安全，并且可以实现多层嵌套捕获处理。</li>
</ul>

<h3 id="windows">在windows下的实现</h3>

<p>这个就不用多说了，在vs下直接用 __try、__except 关键字就行了，如果在mingw下编译， 通过 setjmp实现也很方便。</p>

<h3 id="section">具体使用</h3>

<p>注： 由于使用setjmp 进行寄存器现场保护， 如果使用整型局部变量， 有可能会被编译器优化到寄存器中。
所以try内部的修改，可能会在异常捕获后，被会恢复掉。
最好加上volatile来禁止优化。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>__tb_volatile__ tb_size_t i = 0;
__tb_try
{
    i++;
    // 捕获段错误
    *((__tb_volatile__ tb_size_t*)0) = 0;
    // 捕获除0错误
    // __tb_volatile__ tb_size_t a = 0; a /= a;
}
__tb_except(1)
{
    // __tb_except(1): 处理异常
    // __tb_except(0): 路由异常到外层， 支持嵌套处理
}
__tb_end
</code></pre>
</div>

<h3 id="section-1">注意事项</h3>

<p>有些平台异常捕获是被禁用的，所以如果确实想要使用这种异常捕获机制，首先得确保对应平台下的配置文件plat/xxx/config.h</p>

<p>定义了TB_CONFIG_EXCEPTION_ENABLE这个宏，然后重新编译才行。</p>

<p>虽然tbox对异常支持的挺完善了，但是个人还是不建议太过频繁的使用异常捕获。</p>


  </article>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//zh-tboox.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      </div>
    </div>
    
    <footer class="footer">
  <div id="gotop">^</div>
  <br>
	@2016 tboox.net
</footer>

    
  </body>

</html>
